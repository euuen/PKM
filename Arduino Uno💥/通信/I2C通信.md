# I2C通信

## 省流版本

用`Wire`库通信。

## 细节版本

当你已经玩转了串口（USART），能让两块Arduino板子顺畅对话之后，一个很现实的问题就会浮现出来：​**​如果我想让一块Arduino主板同时和十几个传感器、屏幕、存储器模块“交谈”，该怎么办？​**​ 如果用USART，每增加一个设备，你几乎就要占用一对宝贵的TX/RX引脚，主板上的引脚资源很快会捉襟见肘，线路也会乱成一团麻。

这时，一种更优雅、更节省引脚的通信方式就该登场了，它就是 ​**​I2C​**​。

你可以把I2C想象成一场​**​精心组织的电话会议​**​。在这个会议中：

- •
    
    ​**​只有两条公共线路​**​：一条叫​**​SDA​**​（串行数据线），负责实际的数据传输；另一条叫​**​SCL​**​（串行时钟线），负责同步所有与会者的节奏，像是一个节拍器，告诉大家什么时候该读取数据了。无论你连接多少个设备，都只需要这两根线，再加上一根共用的地线（GND）。这极大地节省了主板引脚和连接线的数量。
    
- •
    
    ​**​每个人都有唯一工号​**​：每个连接到I2C总线上的设备（比如一个温度传感器、一个OLED屏幕）都有一个独一无二的​**​设备地址​**​。这个地址通常是出厂时就预设好的，或者通过少数几个引脚的高低电平来配置。当主板（作为这场会议的​**​主机​**​）想要和某个设备通话时，它不会直接喊“喂！”，而是先在SDA线上广播这个设备的地址：“007号，请回答”。只有地址匹配的设备（称为​**​从机​**​）才会响应，其他设备则会保持静默，等待呼叫自己的地址。
    
- •
    
    ​**​严格的会议纪律​**​：这场会议遵循着非常严格的协议。通信总是由主机发起，主机控制着SCL时钟线。通信的开始有一个明确的​**​起始信号​**​（SDA在SCL高电平时拉低），结束有一个明确的​**​停止信号​**​（SDA在SCL高电平时拉高）。所有的数据交换都按字节进行，每传输一个字节，接收方都必须回一个​**​应答信号​**​（ACK），告诉发送方“我收到了，请发送下一个”，如果没收到应答（NACK），主机就知道可能出错了。
    

​**​那么，这套复杂的“会议规则”对我们实际玩Arduino有什么好处呢？细节体现在哪里？​**​

1. 1.
    
    ​**​极致的引脚经济性​**​：这是I2C最迷人的特点。无论你是要读取温湿度、测量气压，还是在屏幕上显示文字，你都可以将它们全部并联在那两根线上（SDA和SCL）。你的Arduino Uno只需要占用A4（SDA）和A5（SCL）两个引脚，就能理论上连接多达128个不同的设备（因为设备地址是7位的）。这让你可以构建非常复杂而线路清爽的系统。
    
2. 2.
    
    ​**​庞大的现成模块生态​**​：市面上几乎你能想到的所有传感器和模块，都有对应的I2C版本。你非常容易就能买到I2C接口的OLED屏幕、温湿度传感器、实时时钟、数字陀螺仪、IO扩展芯片等等。这意味着你不需要从底层去琢磨如何实现I2C协议，因为——
    
3. 3.
    
    ​**​强大的库函数支持​**​：Arduino社区为几乎所有流行的I2C设备编写了现成的库。你的编程工作因此变得异常简单。比如，你想在OLED屏幕上显示“Hello World”，代码通常简化成这样：
    
```cpp
#include <Wire.h> // I2C核心库 
#include <Adafruit_SSD1306.h> // 屏幕的专用库  

Adafruit_SSD1306 display(128, 64, &Wire);  

void setup() {   
	display.begin(SSD1306_SWITCHCAPVCC, 0x3C); // 初始化，并告诉它设备地址是0x3C
	display.setTextSize(2);   
	display.setTextColor(WHITE); 
}  
void loop() {   
	display.clearDisplay();   
	display.setCursor(0,0);   
	display.println("Hello World!");   
	display.display(); 
}
```
    
	你看，你完全不需要关心数据是如何一位一位发送出去的，库函数已经帮你封装好了所有复杂的底层操作。你只需要调用 `println()`这样直观的函数，就像在操作普通的串口监视器一样。
    
4. 4.
    
    ​**​解决电平转换的烦恼​**​：有时候，你的主板是5V的，但某个传感器是3.3V的，直接连接可能会烧坏设备。对于I2C总线，你只需要一个简单的电平转换模块，转换SDA和SCL这两根线即可，而不需要处理一大堆并行的数据线。
    

当然，I2C也并非完美。它的协议比USART复杂，因此绝对速度通常慢一些，而且总线长度不宜过长。但对于单片机领域绝大多数中低速、短距离、多设备的应用场景（这恰恰是Arduino项目最常遇到的），它几乎是无可替代的最佳选择。

所以，从USART到I2C，你不仅仅是学会了一种新的通信协议，更是获得了一种​**​以极简方式连接复杂世界​**​的系统级思维。它让你从“一对一”的单独对话，跃升到了“一对多”的全局调度，你的项目也因此拥有了集成更多功能、变得更为强大的可能。

## Wire库

### 接受数据